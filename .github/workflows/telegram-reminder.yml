name: Telegram Quit Smoking Reminder

on:
  workflow_dispatch:   # manual test
  schedule:
    - cron: "20 6 * * *"   # 08:20 Israel
    - cron: "0 8 * * *"    # 10:00 Israel
    - cron: "20 10 * * *"  # 12:20 Israel
    - cron: "0 12 * * *"   # 14:00 Israel
    - cron: "0 14 * * *"   # 16:00 Israel
    - cron: "0 16 * * *"   # 18:00 Israel

jobs:
  send-message:
    runs-on: ubuntu-latest
    steps:
      - name: Determine message
        id: choose
        run: |
          # Times in UTC (minutes from midnight)
          T1=$((6*60+20))   # 06:20 UTC -> 08:20 IL
          T2=$((8*60+0))    # 08:00 UTC -> 10:00 IL
          T3=$((10*60+20))  # 10:20 UTC -> 12:20 IL
          T4=$((12*60+0))   # 12:00 UTC -> 14:00 IL
          T5=$((14*60+0))   # 14:00 UTC -> 16:00 IL
          T6=$((16*60+0))   # 16:00 UTC -> 18:00 IL

          H=$(date -u +%H)
          M=$(date -u +%M)
          NOW=$((10#$H*60 + 10#$M))

          MODE="${{ github.event_name }}"

          # Decide which slot we're targeting
          SLOT=""

          if [ "$MODE" = "workflow_dispatch" ]; then
            # Manual run â†’ pick the *next* upcoming slot
            if   [ "$NOW" -lt "$T1" ]; then SLOT="T1"
            elif [ "$NOW" -lt "$T2" ]; then SLOT="T2"
            elif [ "$NOW" -lt "$T3" ]; then SLOT="T3"
            elif [ "$NOW" -lt "$T4" ]; then SLOT="T4"
            elif [ "$NOW" -lt "$T5" ]; then SLOT="T5"
            elif [ "$NOW" -lt "$T6" ]; then SLOT="T6"
            else SLOT="T1"  # ××—×¨×™ 18:00 ×™×©×¨××œ â†’ ×ž×¨××” ××ª ×©×œ 08:20 ×©×œ ×ž×—×¨
            fi
          else
            # Scheduled run â†’ pick based on exact current time
            if   [ "$NOW" -eq "$T1" ]; then SLOT="T1"
            elif [ "$NOW" -eq "$T2" ]; then SLOT="T2"
            elif [ "$NOW" -eq "$T3" ]; then SLOT="T3"
            elif [ "$NOW" -eq "$T4" ]; then SLOT="T4"
            elif [ "$NOW" -eq "$T5" ]; then SLOT="T5"
            elif [ "$NOW" -eq "$T6" ]; then SLOT="T6"
            else SLOT="FALLBACK"
            fi
          fi

          # Build the right message
          if [ "$SLOT" = "T1" ]; then
            IL_TIME="08:20"
            BASE_MSG="×‘×•×§×¨ ×˜×•×‘ ××ž×™×¨ â˜€ï¸ ×¢×•×“ ×™×•× ×—×“×© ×‘×œ×™ ×¡×™×’×¨×™×•×ª. ×–×• ×”×ª×—×œ×” ×—×–×§×”."
          elif [ "$SLOT" = "T2" ]; then
            IL_TIME="10:00"
            BASE_MSG="×¢×©×¨ ×‘×‘×•×§×¨ ðŸ’ª ×”×’×•×£ ×©×œ×š × ×§×™ ×™×•×ª×¨ ×ž×ž×” ×©×”×•× ×”×™×” ×ž×–×” ×©× ×™×."
          elif [ "$SLOT" = "T3" ]; then
            IL_TIME="12:20"
            BASE_MSG="×¦×”×¨×™×™× ×ž×ª×§×¨×‘×™× ðŸŒ¤ï¸ ××ª×” ×©×•×œ×˜ ×‘×”×¨×’×œ â€” ×œ× ×”×”×¨×’×œ ×‘×š."
          elif [ "$SLOT" = "T4" ]; then
            IL_TIME="14:00"
            BASE_MSG="14:00 â€” ×”×–×ž×Ÿ ×”×§×œ××¡×™ ×œ×¡×™×’×¨×™×”. ××‘×œ ××ª×” ×ž×•×›×™×— ×©×ª×‘× ×™×ª ×™×©× ×” ×œ× ×ž×—×–×™×§×” ××•×ª×š."
          elif [ "$SLOT" = "T5" ]; then
            IL_TIME="16:00"
            BASE_MSG="16:00 ðŸ§  ×”×’×•×£ ×ž×—×¤×© ×”×¤×¡×§×”, ×œ× ×¡×™×’×¨×™×”. ××ª×” ×©× ×œ×‘ â€” ×•×–×” ×›×œ ×”×”×‘×“×œ."
          elif [ "$SLOT" = "T6" ]; then
            IL_TIME="18:00"
            BASE_MSG="18:00 ðŸŒ™ ×¢×•×“ ×—×¦×™ ×™×•× ×¢×‘×¨ ×‘×œ×™ ×¢×™×©×•×Ÿ. ××ª×” ×‘×ª×”×œ×™×š ××ž×™×ª×™ â€” ×•×–×” ×ž×•×¨×’×©."
          else
            IL_TIME=""
            BASE_MSG="×ª×–×›×•×¨×ª âœ¨ ××ª×” ×œ× ×ž×¢×©×Ÿ. ×–×” ×¨×§ ×”×¨×’×œ ×©×ž×ª×¤×¨×§."
          fi

          if [ "$MODE" = "workflow_dispatch" ]; then
            if [ -n "$IL_TIME" ]; then
              MSG="(×‘×“×™×§×” ×™×“× ×™×ª) ×”×ª×–×›×•×¨×ª ×”×‘××” ×©×œ×š ×‘×©×¢×” ${IL_TIME} ×™×©×¨××œ:\n\n${BASE_MSG}"
            else
              MSG="(×‘×“×™×§×” ×™×“× ×™×ª) ${BASE_MSG}"
            fi
          else
            MSG="${BASE_MSG}"
          fi

          echo "msg=$MSG" >> "$GITHUB_OUTPUT"

      - name: Send Telegram Message
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.CHAT_ID }}" \
            --data-urlencode "text=${{ steps.choose.outputs.msg }}"
